<!--index.wxml-->
<view class="container">
  
  <!-- 1. Empty State / Upload Screen -->
  <!-- 1. Empty State / Upload Screen -->
  <view class="upload-screen" wx:if="{{!imagePath}}">
    <view class="home-card">
      <view class="home-title">图片标注</view>
      <view class="home-subtitle">装修量房速记、家具尺寸标记、打孔定位标记</view>
      
      <view class="home-buttons">
        <view class="home-btn btn-camera" bindtap="onCameraTap">
          <image class="home-btn-icon" src="/camera.png" mode="aspectFit"></image>
          <view class="home-btn-title">拍照标注</view>
          <view class="home-btn-desc">现场拍照，即拍即标记</view>
        </view>
        
        <view class="home-btn btn-album" bindtap="onAlbumTap">
          <image class="home-btn-icon" src="/photo.png" mode="aspectFit"></image>
          <view class="home-btn-title">相册上传</view>
          <view class="home-btn-desc">上传已有图片进行标记</view>
        </view>
      </view>
    </view>
  </view>

  <!-- 2. Workspace (Visible when image is loaded) -->
  <view class="workspace" wx:else>
    <!-- Gesture Area: Handles Zoom/Pan/Rotate for the image container -->
    <view class="gesture-area" 
          bindtouchstart="onTouchStart" 
          bindtouchmove="onTouchMove" 
          bindtouchend="onTouchEnd"
          catchtap="onBackgroundTap">
      
      <!-- Transform Container: Holds Image and Lines. 
           We apply CSS transform here so lines stick to image. -->
      <view class="transform-container" 
            style="transform: translate({{imgX}}px, {{imgY}}px) scale({{imgScale}}) rotate({{imgAngle}}deg); width:{{imgWidth}}px; height:{{imgHeight}}px;">
        
        <!-- The Image -->
        <image class="target-image" src="{{imagePath}}" mode="aspectFit" style="width:100%; height:100%;"></image>

        <!-- Lines Layer -->
        <block wx:for="{{lines}}" wx:key="id">
          <!-- Line Group -->
          <view class="line-group {{item.isSelected ? 'selected' : ''}}">
            
            <!-- Standard Line -->
            <view class="visual-line" wx:if="{{item.type !== 'leader'}}"
                  style="left:{{item.left}}px; top:{{item.top}}px; width:{{item.length}}px; transform: rotate({{item.angle}}deg);"
                  catchtouchstart="onLineTouchStart"
                  catchtouchmove="onLineTouchMove"
                  catchtouchend="onLineTouchEnd"
                  data-id="{{item.id}}">
              
              <!-- 1. Hit Area (Transparent, larger touch target) -->
              <view class="hit-area"></view>

              <!-- Dynamic Arrow Start -->
              <view class="arrow start" 
                    style="border-right-color: {{item.color}}; border-width: {{item.strokeWidth * 3}}px {{item.strokeWidth * 5}}px {{item.strokeWidth * 3}}px 0;"></view>
              
              <!-- Dynamic Line Stroke -->
              <view class="line-stroke" 
                    style="background-color: {{item.color}}; height: {{item.strokeWidth}}px;"></view>
              
              <!-- Dynamic Arrow End -->
              <view class="arrow end" 
                    style="border-left-color: {{item.color}}; border-width: {{item.strokeWidth * 3}}px 0 {{item.strokeWidth * 3}}px {{item.strokeWidth * 5}}px;"></view>
              
              <!-- Tag (Parallel to line) -->
              <view class="line-tag {{item.isFlipped ? 'flipped' : ''}}" 
                    style="{{item.tagStyle}} font-size: {{item.fontSize}}px;">
                {{item.text}}
              </view>
            </view>

            <!-- Leader Line -->
            <view class="leader-group-container" wx:if="{{item.type === 'leader'}}"
                  catchtouchstart="onLineTouchStart"
                  catchtouchmove="onLineTouchMove"
                  catchtouchend="onLineTouchEnd"
                  data-id="{{item.id}}">
              
              <!-- Diagonal Line (A to B) using transform -->
              <view class="leader-diagonal"
                    style="left:{{item.diagLeft}}px; top:{{item.diagTop}}px; width:{{item.diagLen}}px; height:{{item.strokeWidth}}px; transform: rotate({{item.diagAngle}}deg); background-color: {{item.color}};">
              </view>

              <!-- Text Platform (Horizontal at B) -->
              <!-- Positioned at B (item.bx, item.by) -->
              <!-- If B > A (Right): Text flows right. If B < A (Left): Text flows left (transform -100%) -->
              <view class="leader-text-wrapper" 
                    style="left:{{item.bx}}px; top:{{item.by}}px; transform: {{item.bx < item.ax ? 'translate(-100%, 0)' : 'none'}};">
                
                <!-- The Text and Underline -->
                <view class="leader-tag" 
                      style="border-bottom: {{item.strokeWidth}}px solid {{item.color}}; font-size: {{item.fontSize}}px; color: #fff; background-color: rgba(0,0,0,0.6); border-radius: 4px; padding: 2px 6px;">
                  <text>{{item.text}}</text>
                </view>
              </view>

              <!-- Anchor A (Circle) -->
               <!-- Using existing anchor logic if selected, BUT we also need a visual anchor always? User image shows hollow circle. -->
               <!-- The 'anchor-circle' below is for controls. Let's add a visual anchor for leader line. -->
               <view class="leader-anchor-dot" 
                     style="left:{{item.ax}}px; top:{{item.ay}}px; border-color: {{item.color}}; width: {{item.strokeWidth * 3 + 4}}px; height: {{item.strokeWidth * 3 + 4}}px; border-width: {{item.strokeWidth}}px;">
               </view>

            </view>

            <!-- Control Anchors (Only visible when selected) -->
            <block wx:if="{{item.isSelected}}">
              <!-- Start Anchor (A) -->
              <view class="anchor-circle"
                    style="left:{{item.ax}}px; top:{{item.ay}}px;"
                    catchtouchstart="onAnchorStart"
                    catchtouchmove="onAnchorMove"
                    catchtouchend="onAnchorEnd"
                    data-type="a"
                    data-id="{{item.id}}">
              </view>

              <!-- End Anchor (B) -->
              <view class="anchor-circle"
                    style="left:{{item.bx}}px; top:{{item.by}}px;"
                    catchtouchstart="onAnchorStart"
                    catchtouchmove="onAnchorMove"
                    catchtouchend="onAnchorEnd"
                    data-type="b"
                    data-id="{{item.id}}">
              </view>
            </block>

          </view>
        </block>

      </view> <!-- End Transform Container -->
    </view>

    <!-- UI Overlay (Fixed Controls) -->
    <view class="ui-overlay" wx:if="{{!hasSelection}}">
      <view class="overlay-buttons">
        <view class="btn-action btn-add" bindtap="onAddLine">
          <image class="btn-icon" src="/biaozhu.svg"></image>
          <text class="btn-text">尺寸</text>
        </view>
        <view class="btn-action btn-leader" bindtap="onAddLeaderLine">
          <!-- Icon for leader line. I'll use text or a simple CSS shape if no icon. Or repurpose biaozhu.svg? -->
          <!-- I will assume a new icon or just text for now -->
          <view class="icon-leader" style="width:24px; height:24px; border:2px solid #fff; border-radius:50%; position:relative; margin-bottom:2px;">
             <view style="position:absolute; top:50%; left:50%; width:10px; height:2px; background:#fff; transform:translate(0, -50%) rotate(-45deg); transform-origin:0 50%;"></view>
          </view>
          <text class="btn-text">引出</text>
        </view>
      </view>
    </view>
    
    <!-- Magnifier (Visible when dragging anchor) -->
    <view class="magnifier" wx:if="{{showMagnifier}}" style="left:{{magX}}px; top:{{magY}}px;">
      <image class="magnifier-img" 
             src="{{imagePath}}" 
             style="width:{{imgWidth}}px; height:{{imgHeight}}px; transform: translate({{magImgTx}}px, {{magImgTy}}px) scale({{magImgScale}}) rotate({{magImgAngle}}deg);">
      </image>
    </view>

    <!-- Bottom Edit Toolbar (Visible when selected) -->
    <view class="edit-toolbar" wx:if="{{hasSelection}}">
      
      <!-- Tag Edit -->
      <view class="tool-section">
        <text class="tool-label">{{selectedLineType === 'leader' ? '内容' : '数值'}}</text>
        <view class="input-group">
          <!-- Note: Dynamic Type binding might not work with replace_file_content if I don't see the context. I'll assume I can edit it. -->
           <!-- Actually I already passed the type edit in previous JS execution? No, I need to do it here in WXML -->
          <input class="tag-input" 
                 type="{{selectedLineType === 'leader' ? 'text' : 'number'}}" 
                 value="{{tagValue}}" 
                 placeholder="请输入" 
                 bindinput="onTagValueInput" />
          
          <!-- Unit Toggle (Hide for Leader) -->
          <view class="unit-toggle" wx:if="{{selectedLineType !== 'leader'}}">
            <view class="unit-btn {{tagUnit === 'mm' ? 'active' : ''}}" bindtap="onSetUnit" data-unit="mm">mm</view>
            <view class="unit-btn {{tagUnit === 'cm' ? 'active' : ''}}" bindtap="onSetUnit" data-unit="cm">cm</view>
          </view>
        </view>
      </view>
      
      <!-- Width -->
      <view class="tool-section">
        <text class="tool-label">粗细</text>
        <view class="btn-circle" bindtap="onDecreaseWidth">-</view>
        <view class="btn-circle" bindtap="onIncreaseWidth">+</view>
      </view>
      
      <!-- Color -->
      <scroll-view scroll-x class="color-scroll" enable-flex>
        <view class="color-item" wx:for="{{colors}}" wx:key="*this" 
              style="background-color: {{item}};" 
              bindtap="onSelectColor" data-color="{{item}}"></view>
      </scroll-view>

      <!-- Font Size -->
      <view class="tool-section">
        <text class="tool-label">字号</text>
        <view class="btn-circle" bindtap="onDecreaseFontSize">-</view>
        <view class="btn-circle" bindtap="onIncreaseFontSize">+</view>
      </view>
    </view>

    <!-- Top Left Controls -->
    <view class="top-left-controls">
      <view class="btn-mini btn-back" bindtap="onBackTap">返回</view>
    </view>

    <!-- Top Right Controls -->
    <view class="top-controls">
      <view class="btn-mini btn-delete" bindtap="onDeleteLine" wx:if="{{hasSelection}}">删除</view>
      <view class="btn-mini btn-save" bindtap="onSaveImage">保存到相册</view>
    </view>

  </view>

  <!-- Hidden Canvas for Export -->
  <canvas type="2d" id="exportCanvas" class="export-canvas" style="width:{{canvasWidth}}px; height:{{canvasHeight}}px; position:fixed; left:0; top:0; opacity:0; pointer-events:none; z-index:-1000;"></canvas>

  <!-- Input Modal -->
  <view class="modal-mask" wx:if="{{showInput}}">
    <view class="modal-content">
      <view class="modal-title">编辑标签</view>
      <input class="modal-input" 
             value="{{inputText}}" 
             bindinput="onInputTextChange"
             focus="{{showInput}}"
             confirm-type="done"
             bindconfirm="onInputConfirm"/>
      <view class="modal-footer">
        <button class="btn-cancel" bindtap="onInputCancel">取消</button>
        <button class="btn-confirm" bindtap="onInputConfirm">确定</button>
      </view>
    </view>
  </view>

  <!-- Hidden Canvas for Export -->
  <canvas type="2d" id="exportCanvas" class="export-canvas"></canvas>

</view>
